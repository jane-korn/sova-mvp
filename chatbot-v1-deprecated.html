<!DOCTYPE html>
<!--
================================================================================
PROPRIETARY AND CONFIDENTIAL
Copyright (c) 2025 Sova Pty Ltd. All Rights Reserved.

This software and its documentation are protected by copyright law and
international treaties. Unauthorized reproduction, distribution, or use of
this software, in whole or in part, is strictly prohibited and may result
in severe civil and criminal penalties.

Protected by Australian Copyright Act 1968
Protected by Digital Millennium Copyright Act (DMCA)
================================================================================
-->
<!-- UPDATED: 2025-12-09 - Version 4.0 - MAJOR: Complete knowledge base grounding (ALL 281 tools, interconnections framework, strict grounding, 2-3 turn efficiency) -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Sova - Chat with Your Guide</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 300;
            background: #2d2828;
            color: #f5f5dc;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; width: 100%; }

        /* Header */
        header {
            padding: 1rem 0;
            border-bottom: 1px solid rgba(234, 255, 196, 0.1);
            background: #2d2828;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-content a { display: flex; text-decoration: none; }
        .header-content img { height: 90px; }

        /* Bird Icon */
        .bird-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            height: 45px;
            opacity: 0.4;
            z-index: 1000;
            transition: opacity 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            cursor: pointer;
        }
        .bird-icon:hover { opacity: 0.7; }

        /* Chat Layout */
        .chat-section {
            flex: 1;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            min-height: calc(100vh - 122px);
            padding: 2rem 0 10rem 0;
        }
        .chat-wrapper { max-width: 700px; width: 100%; display: flex; flex-direction: column; gap: 1.5rem; }
        .messages-area { display: flex; flex-direction: column; gap: 1.5rem; }

        /* Messages */
        .message { animation: fadeInUp 0.4s cubic-bezier(0.23, 1, 0.32, 1); }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.sova .message-content { color: #f5f5dc; font-size: 1.125rem; line-height: 1.7; }
        .message.user { align-self: flex-end; max-width: 80%; }
        .message.user .message-content {
            background: rgba(234, 255, 196, 0.08);
            border: 1px solid rgba(234, 255, 196, 0.15);
            border-radius: 16px;
            padding: 1rem 1.25rem;
            font-size: 1rem;
        }
        .message-content p { margin-bottom: 1rem; }
        .message-content p:last-child { margin-bottom: 0; }
        .message-content ul, .message-content ol { margin: 1rem 0; padding-left: 1.5rem; }
        .message-content li { margin-bottom: 0.5rem; color: rgba(245, 245, 220, 0.9); }
        .message-content strong { font-weight: 600; color: #eaffc4; }
        .message-content em { font-style: italic; opacity: 0.85; }
        .message-content a { color: #eaffc4; text-decoration: none; border-bottom: 1px solid rgba(234, 255, 196, 0.3); }
        .message-content a:hover { border-bottom-color: #eaffc4; }

        /* Typing indicator */
        .typing-indicator { display: flex; gap: 6px; padding: 1rem 0; }
        .typing-indicator span {
            width: 8px; height: 8px;
            background: rgba(234, 255, 196, 0.5);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Element Buttons */
        .element-buttons { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 1.5rem; }
        .element-btn {
            background: transparent;
            border: 1px solid rgba(234, 255, 196, 0.25);
            color: #eaffc4;
            padding: 0.75rem 1.5rem;
            border-radius: 100px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            font-family: inherit;
        }
        .element-btn:hover {
            background: rgba(234, 255, 196, 0.1);
            border-color: rgba(234, 255, 196, 0.5);
            transform: translateY(-1px);
        }

        /* Input Area */
        .input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2d2828;
            border-top: 1px solid rgba(234, 255, 196, 0.1);
            padding: 1rem 2rem;
            z-index: 100;
        }
        .input-wrapper {
            max-width: 700px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .input-row { display: flex; gap: 0.75rem; align-items: flex-end; }
        .input-field {
            flex: 1;
            background: rgba(245, 245, 220, 0.03);
            border: 1px solid rgba(234, 255, 196, 0.15);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            color: #f5f5dc;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 300;
            resize: none;
            min-height: 56px;
            max-height: 150px;
            transition: all 0.3s;
        }
        .input-field:focus { outline: none; border-color: rgba(234, 255, 196, 0.4); background: rgba(245, 245, 220, 0.05); }
        .input-field::placeholder { color: rgba(245, 245, 220, 0.35); }
        .input-field:disabled { opacity: 0.5; cursor: not-allowed; }

        .send-btn {
            background: #eaffc4;
            border: none;
            color: #2d2828;
            padding: 1rem 1.75rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }
        .send-btn:hover:not(:disabled) { background: #d4f0a8; transform: translateY(-2px); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Context Options */
        .context-options {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(234, 255, 196, 0.1);
        }
        .context-btn {
            background: transparent;
            border: 1px solid rgba(234, 255, 196, 0.2);
            color: rgba(245, 245, 220, 0.7);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .context-btn:hover { border-color: rgba(234, 255, 196, 0.5); color: #f5f5dc; }
        .context-btn.active { border-color: #eaffc4; color: #eaffc4; background: rgba(234, 255, 196, 0.1); }
        .context-btn svg { width: 16px; height: 16px; }

        /* File Upload */
        .file-input { display: none; }
        .file-preview {
            background: rgba(234, 255, 196, 0.05);
            border: 1px solid rgba(234, 255, 196, 0.15);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .file-preview span { font-size: 0.875rem; color: #b8d78f; }
        .file-remove {
            background: none;
            border: none;
            color: rgba(245, 245, 220, 0.5);
            cursor: pointer;
            padding: 0.25rem;
        }
        .file-remove:hover { color: #f5f5dc; }

        /* Tool Card */
        .tool-card {
            background: rgba(234, 255, 196, 0.05);
            border: 1px solid rgba(234, 255, 196, 0.12);
            border-radius: 12px;
            padding: 1.25rem;
            margin: 1rem 0;
        }
        .tool-card h4 { color: #eaffc4; font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .tool-card p { color: #b8d78f; font-size: 0.875rem; margin-bottom: 0.75rem; opacity: 0.9; }
        .tool-card a {
            display: inline-block;
            color: #eaffc4;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            border-bottom: 1px solid rgba(234, 255, 196, 0.3);
        }

        /* Referral Card */
        .referral-card {
            background: rgba(234, 255, 196, 0.05);
            border: 1px solid rgba(234, 255, 196, 0.12);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        .referral-card h4 { color: #eaffc4; font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; }
        .referral-card p { color: #b8d78f; font-size: 0.9375rem; margin-bottom: 1.25rem; opacity: 0.8; }
        .referral-btn {
            display: inline-block;
            background: transparent;
            border: 2px solid #eaffc4;
            color: #eaffc4;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9375rem;
            text-decoration: none;
            transition: all 0.3s;
        }
        .referral-btn:hover { background: rgba(234, 255, 196, 0.1); transform: translateY(-2px); }

        /* Program Card (for ecosystem guide recommendations) */
        .program-card {
            background: rgba(184, 215, 143, 0.08);
            border: 1px solid rgba(184, 215, 143, 0.2);
            border-radius: 12px;
            padding: 1.25rem;
            margin: 1rem 0;
        }
        .program-card h4 { color: #b8d78f; font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .program-card p { color: rgba(245, 245, 220, 0.85); font-size: 0.875rem; margin-bottom: 0.75rem; }
        .program-card a {
            display: inline-block;
            color: #b8d78f;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            border-bottom: 1px solid rgba(184, 215, 143, 0.3);
        }
        .program-card a:hover { border-bottom-color: #b8d78f; }

        /* Ecosystem Guide Link */
        .ecosystem-guide-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 0.75rem 1.25rem;
            background: rgba(234, 255, 196, 0.08);
            border: 1px solid rgba(234, 255, 196, 0.2);
            border-radius: 8px;
            color: #eaffc4;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s;
        }
        .ecosystem-guide-link:hover { background: rgba(234, 255, 196, 0.15); border-color: rgba(234, 255, 196, 0.4); }

        /* Mobile */
        @media (max-width: 768px) {
            .container { padding: 0 1.25rem; }
            .chat-section { padding: 1.5rem 0 12rem 0; }
            .message.sova .message-content { font-size: 1rem; }
            .element-btn { padding: 0.625rem 1.25rem; font-size: 0.875rem; }
            .input-area { padding: 1rem 1.25rem; }
            .input-row { flex-direction: column; }
            .send-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Copy/paste enabled for beta testing -->

    <header>
        <div class="container">
            <div class="header-content">
                <a href="index.html"><img src="sova-logo-main-transparent.png" alt="Sova"></a>
            </div>
        </div>
    </header>

    <!-- Coming Soon overlay removed for local testing -->

    <div class="container">
        <section class="chat-section">
            <div class="chat-wrapper">
                <div class="messages-area" id="messagesArea"></div>
            </div>
        </section>
    </div>

    <div class="input-area">
        <div class="input-wrapper">
            <div id="filePreview" style="display: none;" class="file-preview">
                <span id="fileName"></span>
                <button class="file-remove" onclick="removeFile()">âœ•</button>
            </div>
            <div class="input-row">
                <textarea class="input-field" id="userInput" placeholder="Describe your challenge..." rows="1" onkeydown="handleKeyDown(event)"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
            </div>
            <div class="context-options">
                <button class="context-btn" onclick="triggerUrlInput()" title="Share a website URL">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                    Add website URL
                </button>
                <button class="context-btn" onclick="triggerFileUpload()" title="Upload a document">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    Upload document
                </button>
            </div>
            <input type="file" id="fileInput" class="file-input" accept=".pdf,.doc,.docx,.txt" onchange="handleFileSelect(event)">
        </div>
    </div>

    <a href="assessment-tool.html" title="Take the Assessment">
        <img src="sova-logo-icon-transparent.png" alt="Sova" class="bird-icon">
    </a>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        // Use Netlify Functions proxy for API calls
        const CHAT_API_URL = '/.netlify/functions/chat';

        // State
        let conversationHistory = [];
        let knowledgeBase = null;
        let uploadedFileContent = null;
        let uploadedFileName = null;
        let conversationTurns = 0;

        // ============================================
        // LOAD KNOWLEDGE BASE
        // ============================================
        async function loadKnowledgeBase() {
            try {
                // Load full knowledge base
                const response = await fetch('sova-knowledge-base.json');
                knowledgeBase = await response.json();
                console.log('Knowledge base loaded:', {
                    tools: knowledgeBase.tools.length,
                    questions: knowledgeBase.questions.length,
                    failureQuotes: knowledgeBase.failureQuotes.length,
                    directory: knowledgeBase.directory?.length || 0
                });
            } catch (error) {
                console.error('Failed to load knowledge base:', error);
                // Fallback to empty knowledge base
                knowledgeBase = {
                    tools: [],
                    questions: [],
                    failureQuotes: [],
                    directory: [],
                    elementDefinitions: []
                };
            }
        }

        // ============================================
        // BUILD SYSTEM PROMPT
        // ============================================
        function buildSystemPrompt() {
            // Get ALL tools (not just MVP - this was the bug!)
            const allTools = knowledgeBase?.tools || [];

            // Get ALL failure quotes
            const failureQuotes = knowledgeBase?.failureQuotes || [];

            // Get element definitions
            const elementDefs = knowledgeBase?.elementDefinitions || [];

            // Get ALL directory data (no slicing - another bug!)
            const directory = knowledgeBase?.directory || [];
            const fundingOpps = directory.filter(d => d.need === 'Funding');
            const adviceResources = directory.filter(d => d.need === 'Advice');
            const programResources = directory.filter(d => d.need === 'Programs');
            const communityResources = directory.filter(d => d.need === 'Connections');

            return `You are Sova, a professional startup guide for Australian entrepreneurs. Your goal is to diagnose challenges efficiently (maximum 2-3 exchanges) and provide specific, evidence-based recommendations.

## CRITICAL GROUNDING RULE - READ THIS FIRST

**YOU MUST ONLY USE INFORMATION FROM THIS KNOWLEDGE BASE**

You have access to:
- ${allTools.length} curated tools and methodologies (listed below with URLs)
- ${failureQuotes.length} startup failure research quotes with citations
- ${directory.length} Australian startup resources (grants, accelerators, investors, programs)
- 9-element interconnections framework

**STRICT RULES:**
1. If a user asks about a tool NOT in your knowledge base, respond: "I don't have information on that specific tool, but here's what I do have that solves the same problem..."
2. NEVER recommend tools, methodologies, or resources that aren't explicitly listed below
3. NEVER make up URLs or links - only use URLs provided in this knowledge base
4. If you don't know something, say so and redirect to what you DO know

## CONVERSATION EFFICIENCY TARGET

**Maximum 2-3 exchanges to recommendation:**

**Turn 1:** User states problem â†’ You ask 1-2 diagnostic questions (check interconnections)
**Turn 2:** User answers â†’ You provide recommendation with specific tools

**NEVER:**
- Have long back-and-forth conversations
- Ask multiple rounds of questions
- Delay getting to the recommendation
- Ask "when" questions (when did this start, when do you need it)

**GET TO THE RECOMMENDATION QUICKLY**

## LANGUAGE RULES

1. **NEVER use greetings** - No "G'day", "Hello", "Hi there" at any point
2. **NEVER ask "When" questions** - Focus on what the issue is and how to solve it
3. **Australian English**: organisation, analyse, prioritise, colour
4. **No emojis**
5. **Short paragraphs**: Maximum 2-3 sentences per paragraph. Blank lines between paragraphs
6. **Mirror user's sophistication**: If they use simple language, stay simple. If they use business terms, match them

**Simple language examples:**
- "Getting more customers" NOT "Attracting and acquiring new customers"
- "Understanding what makes you different" NOT "Defining your unique value proposition"

## INTERCONNECTIONS FRAMEWORK - CRITICAL FOR DIAGNOSIS

**BEFORE recommending a solution, check if the symptom is in one element but the ROOT CAUSE is in another:**

### Common Interconnection Patterns:

**FINANCE symptoms (cash flow, profitability, funding):**
Root causes often in:
- GOVERNANCE: No cash flow oversight, weak financial controls
- STRATEGY: Growth outpacing cash generation, wrong pricing model
- PROCESS: Slow invoicing, poor collections, inventory mismanagement
- MARKETING: Wrong customer segments (slow payers), high CAC
- PEOPLE: Lack of financial literacy in sales/ops teams

**MARKETING symptoms (can't get customers, high churn, low conversion):**
Root causes often in:
- PURPOSE: Unclear differentiation, generic positioning
- GOVERNANCE: No brand guidelines, inconsistent messaging
- STRATEGY: Wrong target market, no validated value proposition
- PEOPLE: Team lacks training, wrong skills
- PROCESS: Poor customer experience, service delivery gaps
- TECHNOLOGY: System failures, poor UX

**PEOPLE symptoms (team not performing, high turnover, conflicts):**
Root causes often in:
- GOVERNANCE: No role clarity, no performance frameworks, weak HR policies
- STRATEGY: Unclear direction, employees don't understand priorities
- PROCESS: Burdensome workflows, inefficient systems wasting time
- TECHNOLOGY: Inadequate tools, poor productivity enablers
- PERFORMANCE: No feedback mechanisms, no recognition

**PROCESS symptoms (inefficiencies, bottlenecks, quality issues):**
Root causes often in:
- STRATEGY: Process doesn't align with strategic priorities
- GOVERNANCE: No process standards, no ownership
- TECHNOLOGY: Manual workflows, no automation
- PEOPLE: Skill gaps, inadequate training

**TECHNOLOGY symptoms (implementation failures, poor adoption, system issues):**
Root causes often in:
- STRATEGY: Technology not aligned with business strategy
- PEOPLE: Resistance to change, inadequate skills
- PROCESS: Automating broken processes (fix process first!)
- GOVERNANCE: Poor tech governance, weak vendor management
- FINANCE: Inadequate budget, poor ROI analysis

**STRATEGY symptoms (unclear direction, execution gaps, misalignment):**
Root causes often in:
- GOVERNANCE: Weak oversight, unclear decision rights
- PURPOSE: Unclear mission/vision, no strategic foundation
- PERFORMANCE: No feedback loops to inform strategy
- FINANCE: Resource constraints limiting options

**PURPOSE symptoms (unclear positioning, no differentiation, mission drift):**
Root causes often in:
- GOVERNANCE: No values framework, no purpose oversight

**GOVERNANCE symptoms (slow decisions, conflicts, accountability gaps):**
- Governance is usually THE ROOT CAUSE, not the symptom
- If they have governance problems, these cascade everywhere else

**PERFORMANCE symptoms (not meeting targets, missing KPIs):**
Root causes often in:
- ALL ELEMENTS: Performance is the RESULT of how well all other elements function

### Element Hierarchy (Check in this order):

**TIER 1 - Foundational (fix these first):**
1. GOVERNANCE - Oversight, decision frameworks, accountability
2. PURPOSE - Why you exist, differentiation, mission

**TIER 2 - Strategic Direction:**
3. STRATEGY - Translates purpose into actionable direction

**TIER 3 - Execution (depend on strategy):**
4. MARKETING - Market connection
5. FINANCE - Resource management
6. PEOPLE - Execution workforce
7. PROCESS - How work gets done
8. TECHNOLOGY - Automation & enablement

**TIER 4 - Outcome:**
9. PERFORMANCE - Results measurement, feedback loops

**When diagnosing, always check if foundational elements (Tier 1-2) are broken before recommending execution-level (Tier 3) solutions.**

## NON-NEGOTIABLE RULES FOR ALL ADVICE

**RULE 1: NO SOVA OPINION**
NEVER give Sova's own advice. ALWAYS reference research, tools, or methodologies from your knowledge base. Every recommendation must be backed by evidence.

**RULE 2: CITE SOURCES WITH LINKS**
Every piece of advice must reference:
- Research source (CB Insights, McKinsey, HBR, etc.) with hyperlink
- Startup failure evidence with hyperlink
- Specific tool/framework from your knowledge base with URL

**RULE 3: GOLDEN CIRCLE MANDATORY**
Every recommendation MUST follow WHY â†’ HOW â†’ WHAT structure (see format below)

## THE 3-STEP DIAGNOSTIC APPROACH (FAST, EFFICIENT)

**STEP 1: ACKNOWLEDGE + DIAGNOSE**
State their situation. Reference startup failure research. Ask 1-2 diagnostic questions to check for interconnections.

Example: "You're struggling with customer acquisition. This is a common challenge - 35% of startups fail from no market need (CB Insights). Before I recommend a solution: Do you have a clear target customer definition? (This checks STRATEGY)"

**STEP 2: IDENTIFY GAP + ROOT CAUSE**
User answers â†’ Explain the gap and identify which element is the root cause (not just the symptom).

Example: "The gap is between your marketing activity (symptom) and unclear PURPOSE (root cause). You're trying to acquire customers without differentiated positioning. That's why marketing isn't working."

**STEP 3: RECOMMEND TOOL (GOLDEN CIRCLE)**
Use WHY â†’ HOW â†’ WHAT structure with specific tool from knowledge base.

## RECOMMENDATION FORMAT - GOLDEN CIRCLE (MANDATORY)

**WHY (1 short paragraph with citation and link)**
One sentence explaining why this matters. MUST reference startup failure/success evidence.
Format: "[Problem/insight]. [Research stat with source as hyperlink]."
Example: "Handshake deals destroy friendships and businesses. Co-founder disputes are one of the <a href='https://www.cbinsights.com/research/startup-failure-reasons-top/' target='_blank'>top reasons startups fail (CB Insights)</a>."

**HOW (1 short paragraph with methodology)**
One or two sentences on the approach or framework. Reference the specific methodology name with link from your knowledge base.

**WHAT (1 short paragraph + tool card with link)**
One sentence on the specific action. MUST include tool card with working link from your knowledge base.

**MANDATORY tool card format:**
<div class="tool-card">
<h4>[Tool Name]</h4>
<p>[One sentence on why this helps their situation]</p>
<a href="[URL from knowledge base]" target="_blank">Learn more â†’</a>
</div>

## WHEN PRESENTING OPTIONS

Always offer 2-4 clear options as a list. Keep options short (5-10 words max).

Format as:
- Simple option 1
- Simple option 2
- Simple option 3

Then add: "Or tell me more about your specific situation."

## YOUR COMPLETE KNOWLEDGE BASE

### ELEMENT DEFINITIONS
${elementDefs.map(e => \`**\${e.element}**: \${e.definition}\`).join('\n')}

### ALL ${allTools.length} TOOLS AND METHODOLOGIES (with URLs)

**CRITICAL**: You MUST ONLY recommend tools from this list. If a user asks about a tool not listed here, say "I don't have that specific tool in my knowledge base, but here's what I have that solves the same problem..."

${allTools.map(t => {
    const urlPart = t.url ? \` â†’ \${t.url}\` : '';
    return \`**\${t.name}** (\${t.element}): \${t.sovaContext || t.description}\${urlPart}\`;
}).join('\n\n')}

### STARTUP FAILURE EVIDENCE (${failureQuotes.length} QUOTES WITH CITATIONS)

Use these to support your advice. Always cite the source.

${failureQuotes.map(q => \`**\${q.element}** - "\${q.quote}" (\${q.source})\`).join('\n\n')}

### AUSTRALIAN STARTUP DIRECTORY (${directory.length} RESOURCES)

When users need funding, programs, advice, or connections, recommend from this directory.

**IMPORTANT FILTERING:**
- Match by **need** (Funding/Programs/Advice/Connections)
- Match by **stage** (Idea/Validation/Efficiency/Scale)
- Match by **state** if mentioned (NSW, VIC, QLD, WA, SA, TAS, ACT, NT, National)
- Match by **identity** if mentioned (Women/Indigenous/Migrant/Disability)
- Match by **industry** if relevant (Tech/DeepTech/FinTech/HealthTech/CleanTech/AgTech)

**FUNDING OPPORTUNITIES (${fundingOpps.length} total):**
${fundingOpps.map(f => \`**\${f.name}** (\${f.category}, \${f.state}): \${f.description} | Funding: \${f.funding} | Timeline: \${f.timeline} | URL: \${f.url}\`).join('\n\n')}

**PROGRAMS & ACCELERATORS (${programResources.length} total):**
${programResources.map(p => \`**\${p.name}** (\${p.category}, \${p.state}): \${p.description} | Timeline: \${p.timeline} | URL: \${p.url}\`).join('\n\n')}

**ADVICE & SUPPORT (${adviceResources.length} total):**
${adviceResources.map(a => \`**\${a.name}** (\${a.category}, \${a.state}): \${a.description} | URL: \${a.url}\`).join('\n\n')}

**CONNECTIONS & COMMUNITY (${communityResources.length} total):**
${communityResources.map(c => \`**\${c.name}** (\${c.category}, \${c.state}): \${c.description} | URL: \${c.url}\`).join('\n\n')}

## RECOMMENDING DIRECTORY RESOURCES

Use the program-card format:
<div class="program-card">
<h4>[Name]</h4>
<p>[Description tailored to their situation] â€¢ [Category] â€¢ [Timeline if relevant]</p>
<a href="[URL]" target="_blank">Learn more â†’</a>
</div>

**Always contextualise** - explain WHY this specific resource helps THEIR problem.

For comprehensive directory: "Explore all ${directory.length} programs and funding opportunities at <a href='directory.html' target='_blank'>Sova Directory</a>."

## IF USER PROVIDES A WEBSITE OR DOCUMENT

Acknowledge their specific business and tailor your response. Assure them their data is only used for this conversation.

## WHEN REFERRING TO ASSESSMENT

If deeper analysis would help:
<div class="referral-card">
<h4>Take the [Element] Assessment</h4>
<p>Get a structured view of your [element] foundations with prioritised actions.</p>
<a href="assessment-tool.html?from=chatbot&mode=zoomin&element=[Element]" class="referral-btn">Start Assessment</a>
</div>

Remember: Be direct, be helpful, get to the recommendation within 2-3 exchanges. No fluff, no greetings, no "when" questions. ONLY use knowledge from this prompt.`;
        }


        // ============================================
        // GEMINI API CALL
        // ============================================
        async function callGemini(userMessage, additionalContext = '') {
            conversationTurns++;

            // Build full message with any additional context
            let fullMessage = userMessage;
            if (additionalContext) {
                fullMessage = `${userMessage}\n\n[Additional context provided by user]:\n${additionalContext}`;
            }

            // Add conversation guidance based on turns
            if (conversationTurns >= 4) {
                fullMessage += '\n\n[System note: You have gathered enough context. Move toward a specific recommendation with tools and/or assessment referral.]';
            }

            conversationHistory.push({
                role: 'user',
                parts: [{ text: fullMessage }]
            });

            // Request format for Netlify function
            const requestBody = {
                contents: [
                    { role: 'user', parts: [{ text: buildSystemPrompt() }] },
                    { role: 'model', parts: [{ text: 'I understand. I am Sova, a startup guide for Australian entrepreneurs. I will use the funnel technique to efficiently diagnose challenges and provide specific tool recommendations with evidence.' }] },
                    ...conversationHistory
                ],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 1500,
                }
            };

            try {
                const response = await fetch(CHAT_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) throw new Error(`API error: ${response.status}`);

                const data = await response.json();
                const aiResponse = data.candidates[0].content.parts[0].text;

                conversationHistory.push({
                    role: 'model',
                    parts: [{ text: aiResponse }]
                });

                return aiResponse;
            } catch (error) {
                console.error('Gemini error:', error);
                return "I'm having trouble connecting. Please try again, or explore the assessment tool directly.";
            }
        }

        // ============================================
        // URL HANDLING
        // ============================================
        function triggerUrlInput() {
            const url = prompt('Enter the website URL you\'d like me to review:');
            if (url && url.trim()) {
                const input = document.getElementById('userInput');
                input.value = `Please review this website and help me based on what you find: ${url.trim()}`;
                input.focus();
            }
        }

        // ============================================
        // FILE HANDLING
        // ============================================
        function triggerFileUpload() {
            document.getElementById('fileInput').click();
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            uploadedFileName = file.name;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('filePreview').style.display = 'flex';

            // Read file content
            const reader = new FileReader();
            reader.onload = async (e) => {
                if (file.type === 'application/pdf') {
                    uploadedFileContent = `[PDF Document: ${file.name}] - Note: I can see you've uploaded a PDF. Please tell me what this document is about and what you'd like help with.`;
                } else {
                    uploadedFileContent = e.target.result;
                    // Truncate if too long
                    if (uploadedFileContent.length > 10000) {
                        uploadedFileContent = uploadedFileContent.substring(0, 10000) + '\n\n[Document truncated for length]';
                    }
                }
            };

            if (file.type === 'application/pdf') {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }

        function removeFile() {
            uploadedFileContent = null;
            uploadedFileName = null;
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================
        function startConversation() {
            const greeting = `
                <p>Welcome. I'm Sova, your startup guide. I'm here to help you work through challenges and find practical solutions.</p>
                <p>I can help with:</p>
                <ul>
                    <li><strong>Governance</strong> â€” Structure, roles, accountability, compliance</li>
                    <li><strong>Purpose</strong> â€” Mission, values, why you exist</li>
                    <li><strong>Strategy</strong> â€” Positioning, planning, competitive edge</li>
                    <li><strong>Marketing</strong> â€” Customers, messaging, growth</li>
                </ul>
                <p>More elements coming February 2026.</p>
                <p style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(184, 215, 143, 0.15);"><strong>Tell me a bit about your startup.</strong></p>
                <p style="font-size: 0.9rem; opacity: 0.7; margin-top: 0.5rem;">You can share your website URL or upload a business plan to give me more context. Your data is not stored, copied, or used beyond this conversation â€” it's processed only to provide you with relevant guidance.</p>
            `;
            addSovaMessage(greeting, getElementButtons());
        }

        function getElementButtons() {
            return `
                <div class="element-buttons">
                    <button class="element-btn" onclick="quickSelect('Governance')">Governance</button>
                    <button class="element-btn" onclick="quickSelect('Purpose')">Purpose</button>
                    <button class="element-btn" onclick="quickSelect('Strategy')">Strategy</button>
                    <button class="element-btn" onclick="quickSelect('Marketing')">Marketing</button>
                </div>
            `;
        }

        function quickSelect(element) {
            addUserMessage(`I'd like to discuss ${element}`);
            processMessage(`I'd like to discuss ${element}`);
        }

        function addSovaMessage(content, buttons = '') {
            const messagesArea = document.getElementById('messagesArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message sova';
            messageDiv.innerHTML = `<div class="message-content">${formatMessage(content)}</div>${buttons}`;
            messagesArea.appendChild(messageDiv);
            scrollToBottom();
        }

        function addUserMessage(content) {
            const messagesArea = document.getElementById('messagesArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';

            let displayContent = escapeHtml(content);
            if (uploadedFileName) {
                displayContent += `<br><span style="font-size: 0.875rem; opacity: 0.7;">ðŸ“Ž ${uploadedFileName}</span>`;
            }

            messageDiv.innerHTML = `<div class="message-content"><p>${displayContent}</p></div>`;
            messagesArea.appendChild(messageDiv);
            scrollToBottom();
        }

        function addTypingIndicator() {
            const messagesArea = document.getElementById('messagesArea');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message sova';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
            messagesArea.appendChild(typingDiv);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        function formatMessage(text) {
            if (text.includes('<p>') || text.includes('<div class=')) return text;

            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

            const paragraphs = text.split(/\n\n+/);
            let html = '';
            let hasOptions = false;

            paragraphs.forEach(para => {
                para = para.trim();
                if (!para) return;

                if (para.includes('<div class=')) {
                    html += para;
                } else if (para.match(/^[-â€¢]\s/m)) {
                    const items = para.split(/\n/).filter(l => l.trim());

                    // Filter out the "Or tell me more" option - it should be text, not a button
                    const buttonItems = items.filter(i => !i.match(/or tell me more/i));
                    const textItems = items.filter(i => i.match(/or tell me more/i));

                    // Check if these look like clickable options (short items without links)
                    const looksLikeOptions = buttonItems.length >= 2 && buttonItems.length <= 6 &&
                        buttonItems.every(i => i.length < 150 && !i.includes('http'));

                    if (looksLikeOptions && buttonItems.length > 0) {
                        html += '<div class="element-buttons" style="margin: 1rem 0;">';
                        buttonItems.forEach(item => {
                            const cleanItem = item.replace(/^[-â€¢]\s*/, '').replace(/<[^>]+>/g, '');
                            html += `<button class="element-btn" onclick="quickSelect('${cleanItem.replace(/'/g, "\\'")}')">${cleanItem}</button>`;
                        });
                        html += '</div>';

                        // Add "Or tell me more" as regular text after buttons
                        if (textItems.length > 0) {
                            html += '<p style="margin-top: 0.5rem; opacity: 0.8;">' +
                                textItems.map(i => i.replace(/^[-â€¢]\s*/, '')).join('<br>') + '</p>';
                        }
                    } else {
                        html += '<ul>' + items.map(i => `<li>${i.replace(/^[-â€¢]\s*/, '')}</li>`).join('') + '</ul>';
                    }
                } else if (para.match(/^\d+\.\s/m)) {
                    const items = para.split(/\n/).filter(l => l.trim());
                    html += '<ol>' + items.map(i => `<li>${i.replace(/^\d+\.\s*/, '')}</li>`).join('') + '</ol>';
                } else {
                    html += `<p>${para.split(/\n/).map(l => l.trim()).filter(l => l).join(' ')}</p>`;
                }
            });

            return html || `<p>${text}</p>`;
        }

        function scrollToBottom() {
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        async function processMessage(message) {
            setInputEnabled(false);
            addTypingIndicator();

            // Include file content if uploaded
            let additionalContext = '';
            if (uploadedFileContent) {
                additionalContext = `Document uploaded (${uploadedFileName}):\n${uploadedFileContent}`;
                removeFile(); // Clear after sending
            }

            const response = await callGemini(message, additionalContext);
            removeTypingIndicator();
            addSovaMessage(response);
            setInputEnabled(true);
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message) return;

            addUserMessage(message);
            input.value = '';
            input.style.height = 'auto';

            await processMessage(message);
        }

        function setInputEnabled(enabled) {
            document.getElementById('userInput').disabled = !enabled;
            document.getElementById('sendBtn').disabled = !enabled;
            if (enabled) document.getElementById('userInput').focus();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Auto-resize textarea
        document.getElementById('userInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // Initialize
        loadKnowledgeBase().then(() => {
            startConversation();
        });
    </script>

    <footer style="text-align: center; padding: 1rem; font-size: 0.75rem; color: rgba(245, 245, 220, 0.4); border-top: 1px solid rgba(234, 255, 196, 0.1); margin-top: 2rem;">
        &copy; 2025 Sova. All rights reserved. Assessment tool and content protected by copyright. <a href="terms.html" style="color: #b8d78f;">Terms of Service</a>
    </footer>
</body>
</html>
